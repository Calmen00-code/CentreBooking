@page "/admin-menu"

@using Blazored.Toast.Services;
@using CentreBookingUI.Models
@using CentreBookingUI.Shared

@inject IJSRuntime jsRuntime
@inject HttpClient HttpClient
@inject IToastService ToastService

<h3>Admin Menu</h3>

<DisplayCentre @ref="displayCentre"/>

@* Button for register new centre is hidden when the form to register new centre is shown *@
@if (!IsFormVisible)
{
    <button @onclick="AddCentre">Register New Centre</button>
}

@if (IsFormVisible)
{
    <div>
        <form @onsubmit="OnCentreSubmit">
            <input type="text" placeholder="Centre Name" @bind="NewCentreName"/>
            <button type="submit">Confirm</button>
        </form>
        <br/>
        <button @onclick="CancelAdd">Cancel</button>
    </div>
}

@code {
    private static readonly string _apiurl = "http://localhost:5249/api/CentreBookingApplication/";

    private DisplayCentre? displayCentre;

    private bool IsFormVisible = false;
    private string? NewCentreName { get; set; }

    private void AddCentre()
    {
        IsFormVisible = true;
    }

    private void CancelAdd()
    {
        IsFormVisible = false;
    }

    private async Task OnCentreSubmit()
    {
        string api_request_url = _apiurl + "post-centre";

        // building the centre object to be passed into POST API
        Centre centre = new Centre();
        centre.CentreName = NewCentreName;

        var response = await HttpClient.PostAsJsonAsync(api_request_url, centre);
        if (response.IsSuccessStatusCode)
        {
            // form should be hidden when it is done submitting
            IsFormVisible = false;

            // refresh child component (DisplayCentre.razor) 
            // to show the updated list
            displayCentre.RefreshCentreList();
        }
        else
        {
            var errorContent = await response.Content.ReadAsStringAsync();
            var errorMessage = $"Error: {errorContent}";
            ShowAlert(errorMessage);
        }
    }

    private void ShowSuccess(string msg)
    {
        // jsRuntime.InvokeVoidAsync("alert", msg);
        ToastService.ShowSuccess(msg);
    }

    private void ShowError(string msg)
    {
        // jsRuntime.InvokeVoidAsync("console.log", msg);
        ToastService.ShowError(msg);
    }

    private void ShowWarning(string msg)
    {
        ToastService.ShowWarning(msg);
    }

    private void ShowInfo(string msg)
    {
        ToastService.ShowInfo(msg);
    } 

    private void ShowAlert(string msg)
    {
        jsRuntime.InvokeVoidAsync("alert", msg);
    }
}
